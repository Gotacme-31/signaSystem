generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
}

enum OrderStage {
  REGISTERED
  IN_PROGRESS
  READY
  DELIVERED
}

enum ShippingType {
  PICKUP
  DELIVERY
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
}

enum UnitType {
  METER
  PIECE
}

enum StepStatus {
  PENDING
  DONE
}

enum ShippingStage {
  SHIPPED
  RECEIVED
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users          User[]
  orders         Order[]
  pickupOrders   Order[]         @relation("PickupBranch")
  branchProducts BranchProduct[]
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(STAFF)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])
}

model Customer {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  name      String
  createdAt DateTime @default(now())

  orders Order[]
}

model Product {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  unitType     UnitType
  needsVariant Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  // Reglas de cantidad (validación en Front/Back)
  minQty  Decimal @default(1) @db.Decimal(12, 3)
  qtyStep Decimal @default(1) @db.Decimal(12, 3)

  // Caso especial: SOLO cuando qty = 0.5 (DTF TEXTIL / DTF UV)
  halfStepSpecialPrice Decimal? @db.Decimal(12, 2)

  branchProducts BranchProduct[]
  orderItems     OrderItem[]
  processSteps   ProductProcessStep[]

  variants     ProductVariant[]
  optionGroups ProductOptionGroup[]

  // ✅ NUEVO: parámetros “catálogo” (sin precio aquí)
  params ProductParam[]
}

model BranchProduct {
  id        Int      @id @default(autoincrement())
  branchId  Int
  productId Int
  isActive  Boolean  @default(true)

  // Precio base fallback (si no hay regla por cantidad)
  price     Decimal  @default(0) @db.Decimal(12, 2)
  createdAt DateTime @default(now())

  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // reglas por cantidad
  quantityPrices BranchProductQuantityPrice[]

  // Precio por tamaño/variante
  variantPrices  BranchProductVariantPrice[]

  variantQuantityPrices BranchProductVariantQuantityPrice[]  // <-- Agrega esta línea
  
  // ✅ NUEVO: Precio por parámetro (por sucursal)
  paramPrices    BranchProductParamPrice[]

  @@unique([branchId, productId])
  @@index([branchId])
  @@index([productId])
}

model BranchProductQuantityPrice {
  id              Int      @id @default(autoincrement())
  branchProductId Int
  minQty          Decimal  @db.Decimal(12, 3)
  unitPrice       Decimal  @db.Decimal(12, 2)
  isActive        Boolean  @default(true)
  order           Int      @default(0)

  branchProduct BranchProduct @relation(fields: [branchProductId], references: [id], onDelete: Cascade)

  @@unique([branchProductId, minQty])
  @@index([branchProductId])
}

model BranchProductVariantPrice {
  id              Int @id @default(autoincrement())
  branchProductId Int
  variantId       Int
  price           Decimal @db.Decimal(12, 2)
  isActive        Boolean @default(true)

  branchProduct BranchProduct  @relation(fields: [branchProductId], references: [id], onDelete: Cascade)
  variant       ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([branchProductId, variantId])
  @@index([branchProductId])
  @@index([variantId])
}

model BranchProductVariantQuantityPrice {
  id              Int      @id @default(autoincrement())
  branchProductId Int
  variantId       Int
  minQty          Decimal  @db.Decimal(12, 3)
  unitPrice       Decimal  @db.Decimal(12, 2)
  isActive        Boolean  @default(true)
  order           Int      @default(0)
  
  branchProduct BranchProduct  @relation(fields: [branchProductId], references: [id], onDelete: Cascade)
  variant       ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([branchProductId, variantId, minQty])
  @@index([branchProductId])
  @@index([variantId])
}
model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String
  order     Int     @default(0)
  isActive  Boolean @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  branchVariantPrices BranchProductVariantPrice[]
  orderItems          OrderItem[]
  branchVariantQuantityPrices BranchProductVariantQuantityPrice[] 
  @@unique([productId, name])
  @@index([productId])
}

//
// ✅ NUEVO: catálogo de parámetros por producto (sin precio aquí)
//
model ProductParam {
  id        Int      @id @default(autoincrement())
  productId Int
  name      String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  branchParamPrices BranchProductParamPrice[]

  @@unique([productId, name])
  @@index([productId])
}

//
// ✅ NUEVO: precio de parámetro por sucursal (vía BranchProduct)
//
model BranchProductParamPrice {
  id              Int      @id @default(autoincrement())
  branchProductId Int
  paramId         Int
  priceDelta      Decimal  @default(0) @db.Decimal(12, 2)
  isActive        Boolean  @default(true)

  branchProduct BranchProduct @relation(fields: [branchProductId], references: [id], onDelete: Cascade)
  param         ProductParam  @relation(fields: [paramId], references: [id], onDelete: Cascade)

  @@unique([branchProductId, paramId])
  @@index([branchProductId])
  @@index([paramId])
}

model Order {
  id         Int @id @default(autoincrement())
  branchId   Int
  customerId Int

  pickupBranchId Int
  pickupBranch   Branch @relation("PickupBranch", fields: [pickupBranchId], references: [id])

  stage         OrderStage     @default(REGISTERED)
  shippingType  ShippingType
  paymentMethod PaymentMethod
  shippingStage ShippingStage?

  deliveryDate DateTime
  deliveryTime String?

  notes       String?
  total       Decimal   @default(0) @db.Decimal(12, 2)
  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch   Branch      @relation(fields: [branchId], references: [id])
  customer Customer    @relation(fields: [customerId], references: [id])
  items    OrderItem[]

  @@index([branchId, stage, deliveryDate])
  @@index([pickupBranchId, stage, deliveryDate])
  @@index([customerId])
}

model OrderItem {
  id        Int @id @default(autoincrement())
  orderId   Int
  productId Int

  productNameSnapshot String
  unitTypeSnapshot    UnitType

  quantity Decimal @db.Decimal(12, 3)

  // Variante: compatibilidad + relación estructurada
  variant   Json?
  variantId Int?
  variantRef ProductVariant? @relation(fields: [variantId], references: [id])

  // Snapshot opcional (por auditoría): qué regla minQty se aplicó
  appliedMinQty Decimal? @db.Decimal(12, 3)

  unitPrice Decimal @db.Decimal(12, 2)
  subtotal  Decimal @db.Decimal(12, 2)

  productionStep   String
  currentStepOrder Int             @default(1)
  isReady          Boolean         @default(false)
  steps            OrderItemStep[]

  options OrderItemOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productionStep])
  @@index([variantId])
}

model ProductProcessStep {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String
  order     Int
  isActive  Boolean @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, order])
  @@index([productId])
}

model OrderItemStep {
  id          Int        @id @default(autoincrement())
  orderItemId Int
  name        String
  order       Int
  status      StepStatus @default(PENDING)
  doneAt      DateTime?

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([orderItemId, order])
  @@index([orderItemId, status])
}

model ProductOptionGroup {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String
  required  Boolean @default(false)
  minPick   Int     @default(0)
  maxPick   Int?
  order     Int     @default(0)
  isActive  Boolean @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  options ProductOption[]

  @@index([productId])
}

model ProductOption {
  id         Int     @id @default(autoincrement())
  groupId    Int
  name       String
  priceDelta Decimal @default(0) @db.Decimal(12, 2)
  order      Int     @default(0)
  isActive   Boolean @default(true)

  group ProductOptionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
}

model OrderItemOption {
  id          Int     @id @default(autoincrement())
  orderItemId Int
  optionId    Int
  name        String
  priceDelta  Decimal @db.Decimal(12, 2)

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([optionId])
}

