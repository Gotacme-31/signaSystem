generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
}

enum OrderStage {
  REGISTERED
  IN_PROGRESS
  READY
  DELIVERED
}

enum ShippingType {
  PICKUP
  DELIVERY
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
}

enum UnitType {
  METER
  PIECE
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users          User[]
  orders         Order[]
  pickupOrders   Order[] @relation("PickupBranch") // pedidos que se recogen aqu√≠
  branchProducts BranchProduct[]
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(STAFF)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])
}

model Customer {
  id        Int      @id @default(autoincrement()) // <- tu numero de cliente
  phone     String   @unique
  name      String
  createdAt DateTime @default(now())

  orders Order[]
}

model Product {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  unitType     UnitType
  needsVariant Boolean  @default(false) // toallas/frazadas
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  branchProducts BranchProduct[]
  orderItems     OrderItem[]
}

model BranchProduct {
  id        Int      @id @default(autoincrement())
  branchId  Int
  productId Int
  isActive  Boolean  @default(true)
  price     Decimal  @db.Decimal(12, 2) @default(0) // üëà NUEVO
  createdAt DateTime @default(now())

  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([branchId, productId])
  @@index([branchId])
  @@index([productId])
}

model Order {
  id         Int @id @default(autoincrement())
  branchId   Int
  customerId Int

  pickupBranchId Int
  pickupBranch   Branch @relation("PickupBranch", fields: [pickupBranchId], references: [id])

  stage         OrderStage    @default(REGISTERED)
  shippingType  ShippingType
  paymentMethod PaymentMethod

  deliveryDate DateTime
  deliveryTime String?

  notes       String?
  total       Decimal   @default(0) @db.Decimal(12, 2)
  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch   Branch      @relation(fields: [branchId], references: [id])
  customer Customer    @relation(fields: [customerId], references: [id])
  items    OrderItem[]

  @@index([branchId, stage, deliveryDate])
  @@index([pickupBranchId, stage, deliveryDate])
  @@index([customerId])
}
model OrderItem {
  id        Int @id @default(autoincrement())
  orderId   Int
  productId Int

  productNameSnapshot String
  unitTypeSnapshot    UnitType

  quantity Decimal @db.Decimal(12, 3) // metros o piezas
  variant  Json? // tama√±o, etc.

  unitPrice Decimal @db.Decimal(12, 2)
  subtotal  Decimal @db.Decimal(12, 2)

  // Ej: "DISENO", "IMPRESION", "CALANDRADO", etc.
  productionStep String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productionStep])
}
